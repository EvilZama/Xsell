import uuid
import base64
import qrcode
import ipywidgets as widgets
from IPython.display import display, HTML, clear_output

# --- 1. Global Registry & Utility Functions ---
agent_registry = {}

def register_agent(name, email, whatsapp, instagram, website=None, photo_b64=None):
    unique_id = str(uuid.uuid4())
    profile_url = f"https://agents.example.com/profile/{unique_id}"
    profile = {
        "agent_id": unique_id, "name": name, "email": email, "whatsapp": whatsapp,
        "instagram": instagram, "website": website, "profile_url": profile_url, "photo": photo_b64
    }
    agent_registry[unique_id] = profile
    return profile

def encode_image(uploaded_file_dict):
    if not uploaded_file_dict: return None
    file_info = uploaded_file_dict[0]
    content = file_info['content']
    mime_type = file_info.get('type', 'image/jpeg')
    encoded_string = base64.b64encode(content).decode('utf-8')
    return f"data:{mime_type};base64,{encoded_string}"

def render_portfolio(profile):
    photo_src = profile.get('photo') or "https://via.placeholder.com/120/cccccc/ffffff?text=Agent"
    html_template = f"""
    <div style='font-family: Arial, sans-serif; background-color: #f4f7f6; padding: 30px; border-radius: 15px; border: 1px solid #ddd; max-width: 500px; margin: 20px auto; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1);'>
        <div style='background-color: #2c3e50; color: white; padding: 40px 20px 20px 20px; border-radius: 10px 10px 0 0; margin: -30px -30px 20px -30px; position: relative;'>
            <div style='width: 120px; height: 120px; margin: 0 auto 15px auto; border-radius: 50%; border: 4px solid white; overflow: hidden; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);'>
                <img src='{photo_src}' style='width: 100%; height: 100%; object-fit: cover;'>
            </div>
            <h1 style='margin: 0;'>{profile['name']}</h1>
            <p style='font-style: italic; margin-top: 5px;'>Real Estate Specialist</p>
        </div>
        <div style='margin-bottom: 20px;'>
            <p><strong>Email:</strong> <a href='mailto:{profile['email']}' style='color: #2980b9;'>{profile['email']}</a></p>
            <p><strong>WhatsApp:</strong> <a href='https://wa.me/{profile['whatsapp'].replace("+", "")}' target='_blank' style='color: #27ae60;'>Chat on WhatsApp</a></p>
            <p><strong>Instagram:</strong> <a href='https://instagram.com/{profile['instagram']}' target='_blank' style='color: #8e44ad;'>@{profile['instagram']}</a></p>
            {f"<p><strong>Website:</strong> <a href='{profile['website']}' target='_blank' style='color: #d35400;'>Official Site</a></p>" if profile.get('website') else ""}
        </div>
        <div style='margin-top: 25px; border-top: 1px solid #eee; padding-top: 15px;'>
            <p style='font-size: 0.9em; color: #7f8c8d;'>Unique Profile Link:</p>
            <a href='{profile['profile_url']}' target='_blank' style='font-size: 0.8em; word-break: break-all; color: #95a5a6;'>{profile['profile_url']}</a>
        </div>
    </div>"""
    display(HTML(html_template))

def get_agent_options():
    return [(p['name'], i) for i, p in agent_registry.items()]

# --- 2. UI Layout ---
ui_output = widgets.Output()

# Registration Widgets
name_w = widgets.Text(description='Name:', placeholder='Full Name')
email_w = widgets.Text(description='Email:', placeholder='email@example.com')
wa_w = widgets.Text(description='WhatsApp:', placeholder='Digits only')
insta_w = widgets.Text(description='Instagram:', placeholder='@handle')
web_w = widgets.Text(description='Website:', placeholder='Optional URL')
photo_w = widgets.FileUpload(accept='.png, .jpg, .jpeg', multiple=False, description='Upload Photo', button_style='info')
reg_btn = widgets.Button(description='Register Agent', button_style='success', icon='plus')

# Management Widgets
agent_drop = widgets.Dropdown(options=[], description='Agent:', style={'description_width': 'initial'})
asset_type = widgets.RadioButtons(options=['Portfolio', 'QR Code'], description='View:', disabled=False)
view_btn = widgets.Button(description='Preview Asset', button_style='info', icon='eye')

# --- 3. Callbacks ---
def handle_registration(b):
    with ui_output:
        ui_output.clear_output()
        if not name_w.value or not email_w.value:
            print("Error: Name and Email are mandatory.")
            return
        b64 = encode_image(photo_w.value)
        p = register_agent(name_w.value, email_w.value, wa_w.value, insta_w.value, web_w.value or None, b64)
        agent_drop.options = get_agent_options()
        print(f"Success! '{p['name']}' added. ID: {p['agent_id']}")

def handle_viewing(b):
    with ui_output:
        ui_output.clear_output()
        if not agent_drop.value: return
        p = agent_registry[agent_drop.value]
        if asset_type.value == 'Portfolio':
            render_portfolio(p)
        else:
            qr_data = f"Agent: {p['name']}\nProfile: {p['profile_url']}\nWhatsApp: https://wa.me/{p['whatsapp'].replace('+', '')}\nInsta: https://instagram.com/{p['instagram']}"
            qr = qrcode.QRCode(version=1, box_size=8, border=4)
            qr.add_data(qr_data)
            qr.make(fit=True)
            display(qr.make_image(fill_color="black", back_color="white"))

reg_btn.on_click(handle_registration)
view_btn.on_click(handle_viewing)

# --- 4. Assembly ---
tabs = widgets.Tab(children=[
    widgets.VBox([widgets.HTML("<h3>Register New Agent</h3>"), name_w, email_w, wa_w, insta_w, web_w, photo_w, reg_btn]),
    widgets.VBox([widgets.HTML("<h3>Agent Registry Management</h3>"), agent_drop, asset_type, view_btn])
])
tabs.set_title(0, 'Add Agent')
tabs.set_title(1, 'Manage Assets')

display(widgets.VBox([tabs, ui_output]))
